# Streamlit 웹 앱 (app.py) 사용법

## 개요

`app.py`는 사륜 운행 데이터를 DB 정산 결과로 변환하는 웹 인터페이스입니다.  
브라우저에서 파일을 업로드하고 결과를 다운로드할 수 있습니다.

---

## 사전 준비

### 1. Python 환경 확인

```bash
python --version
```

Python 3.8 이상이 필요합니다.

### 2. 패키지 설치

가상환경이 활성화된 상태에서:

```bash
pip install -r requirements.txt
```

필수 패키지:
- `pandas>=1.5.0,<2.0.0`
- `openpyxl>=3.1.0`
- `numpy>=1.21.0,<1.22.0`
- `streamlit>=1.28.0`

---

## 실행 방법

### 기본 실행

```bash
streamlit run app.py
```

### 특정 포트 지정

```bash
streamlit run app.py --server.port 8502
```

### 브라우저 자동 열기 비활성화

```bash
streamlit run app.py --server.headless true
```

---

## 사용 단계

### 1단계: 앱 실행

터미널에서 다음 명령어 실행:

```bash
cd adjustment
streamlit run app.py
```

실행 후:
- 브라우저가 자동으로 열립니다 (`http://localhost:8501`)
- 또는 수동으로 브라우저에서 `http://localhost:8501` 접속

### 2단계: 파일 업로드

1. 웹 페이지 상단의 **"엑셀 파일 업로드 (.xlsx)"** 영역 클릭
2. 또는 파일을 드래그 앤 드롭
3. 사륜 운행 데이터 엑셀 파일 선택

**지원 파일 형식**: `.xlsx` (Excel 2007 이상)

**주의사항**:
- 다운로드 중인 파일(`.crdownload`)은 사용할 수 없습니다
- 파일이 완전히 다운로드된 후 사용하세요

### 3단계: 자동 처리

파일을 업로드하면 자동으로 처리됩니다:

1. **파일 읽기** (10%)
2. **필수 컬럼 검증** (20%)
3. **데이터 처리** (30-90%)
   - 시간 형식 변환
   - 영업일 계산
   - 운행 시간 계산
   - 자차 포함/미포함 분리
   - 중복 운행 시간 계산
   - 보험료 산출
4. **결과 생성** (90-100%)

진행 상황은 프로그레스 바와 상태 메시지로 표시됩니다.

### 4단계: 결과 확인

처리 완료 후 다음 정보를 확인할 수 있습니다:

#### 통계 정보 (상단)

- **총 건수**: 처리된 운행 건수
- **총 보험료**: 전체 보험료 합계
- **고유 기사 수**: 기사 수
- **총 운행시간**: 전체 운행 시간(분)

#### 탭별 결과

**📋 전체 데이터 탭**
- 모든 운행 건별 상세 정보
- 최대 1,000건 미리보기
- 정렬 및 검색 가능

**📊 통계 탭**
- **담보별 통계**: 담보별 운행시간, 보험료, 운행수
- **상태별 통계**: 상태별 집계
- **자차 포함/미포함 통계**: 자차 관련 통계

**📈 요약 탭**
- 전체 요약 정보
- 자차 포함/미포함 분리 통계
- 중복 운행 시간 통계

### 5단계: 결과 다운로드

1. 페이지 하단의 **"📥 DB 정산 결과 다운로드 (Excel)"** 버튼 클릭
2. 파일이 자동으로 다운로드됩니다
3. 파일명: `DB_사륜_정산결과.xlsx`

---

## 사이드바 정보

왼쪽 사이드바에서 다음 정보를 확인할 수 있습니다:

- **정산 기준**: 배민 기준/DB 기준 영업일 규칙
- **담보별 분당 보험료**: 요율 정보
- **주요 기능**: 처리 기능 요약
- **필수 컬럼**: 입력 파일에 필요한 컬럼 목록

---

## 오류 처리

### 필수 컬럼 누락

**오류 메시지**: "필수 컬럼이 없습니다: ..."

**해결 방법**:
1. 업로드된 파일의 컬럼 목록 확인
2. 필수 컬럼이 포함되어 있는지 확인:
   - 보험사 운행 ID
   - 플랫폼 운행 ID
   - 기사이이디
   - 시작시간 / 종료시간
   - 담보
   - 보험사기준영업일
   - 배민기준영업일
   - 보험사 정산 상태 정보

### 파일 읽기 오류

**오류 메시지**: "엑셀 파일 형식이 올바르지 않습니다"

**해결 방법**:
1. 파일이 `.xlsx` 형식인지 확인
2. 파일이 손상되지 않았는지 확인
3. 파일을 다시 다운로드하거나 저장

### 빈 파일

**오류 메시지**: "입력 파일이 비어있습니다"

**해결 방법**:
1. 파일에 데이터가 포함되어 있는지 확인
2. 올바른 파일을 선택했는지 확인

---

## 고급 사용법

### 대용량 파일 처리

- 대용량 파일의 경우 처리 시간이 오래 걸릴 수 있습니다
- 진행 상황을 프로그레스 바로 확인할 수 있습니다
- 메모리 부족 시 파일을 분할하여 처리하세요

### 결과 미리보기 제한

- 전체 데이터 탭에서는 최대 1,000건만 표시됩니다
- 전체 데이터는 다운로드한 Excel 파일에서 확인하세요

### 여러 파일 처리

현재는 한 번에 하나의 파일만 처리할 수 있습니다.  
여러 파일을 처리하려면:
1. 각 파일을 개별적으로 업로드
2. 또는 CLI 스크립트(`settle_saryun.py`)를 사용하여 배치 처리

---

## 문제 해결

### 브라우저가 자동으로 열리지 않는 경우

1. 터미널에 표시된 URL을 복사
2. 브라우저에서 직접 접속: `http://localhost:8501`

### 포트가 이미 사용 중인 경우

다른 포트로 실행:

```bash
streamlit run app.py --server.port 8502
```

### Streamlit이 설치되지 않은 경우

```bash
pip install streamlit
```

### 앱이 실행되지 않는 경우

1. Python 버전 확인: `python --version`
2. 패키지 설치 확인: `pip list | grep streamlit`
3. 오류 메시지 확인: 터미널에 표시된 오류 메시지 확인

---

## CLI 스크립트와의 차이

| 기능 | Streamlit 앱 (app.py) | CLI 스크립트 (settle_saryun.py) |
|------|----------------------|--------------------------------|
| 사용 방법 | 웹 브라우저 | 명령줄 |
| 파일 업로드 | 드래그 앤 드롭 | 파일 경로 지정 |
| 결과 확인 | 웹에서 미리보기 | 파일 확인 |
| 배치 처리 | 불가능 | 가능 (스크립트 작성) |
| 사용 편의성 | 높음 | 중간 |

---

## 팁

1. **파일 준비**: 업로드 전에 파일이 올바른 형식인지 확인
2. **결과 확인**: 다운로드 전에 통계 탭에서 결과를 미리 확인
3. **오류 대응**: 오류 발생 시 사이드바의 필수 컬럼 목록 확인
4. **대용량 파일**: 매우 큰 파일의 경우 CLI 스크립트 사용 권장

---

## 관련 문서

- [`README.md`](../README.md) - 프로젝트 개요
- [`사륜_정산_프로세스_시나리오.md`](사륜_정산_프로세스_시나리오.md) - 처리 시나리오 상세

