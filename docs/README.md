# 배민 배달 정산 보험료 계산 시스템

## 프로젝트 개요

배민 배달 운행 데이터를 처리하여 보험료를 자동으로 계산하는 시스템입니다. 
Excel 파일을 입력받아 운행 시간을 계산하고, 중복 시간을 제거한 후 담보별 보험료를 산출합니다.

**작성일**: 2025-12-26  
**최종 수정일**: 2025-12-26

## 주요 기능

1. **운행 시간 처리**
   - 시작시간/종료시간 형식 변환 (YYYY-MM-DD HH:MM:SS)
   - 전체 운행시간 계산 (종료시간 - 시작시간)
   - 상태정보가 '00'이 아닌 경우 정산 제외

2. **중복 시간 처리**
   - 이전 종료시간과 다음 시작시간 비교
   - 중복 구간 병합 및 중복 시간 계산
   - 정산 운행시간 산출 (전체 시간 - 중복 시간)

3. **보험료 계산**
   - 담보별 요율 적용
   - 원단위 절사 처리
   - 일별 보험료 집계

4. **Streamlit 웹 인터페이스**
   - 파일 업로드 및 처리
   - 결과 미리보기
   - Excel 파일 다운로드

## 파일 구조

```
adjustment/
├── settle_baemin.py          # 메인 처리 스크립트 (CLI)
├── app.py                    # Streamlit 웹 애플리케이션
├── app_streamlit_wrapper.py  # Streamlit 앱 exe 변환용 래퍼
├── verify_output.py          # 출력 파일 검증 스크립트
├── build_exe.bat             # EXE 빌드 스크립트
├── requirements.txt          # Python 패키지 의존성
├── checklist.md              # 요구사항 체크리스트
├── *.spec                    # PyInstaller 설정 파일
├── .gitignore                # Git 무시 파일 목록
└── docs/                     # 문서 폴더
    ├── README.md            # 이 파일
    ├── 사용법.md            # 상세 사용 가이드
    ├── 개발이력.md          # 개발 이력
    ├── 향후작업.md          # 향후 작업 계획
    └── exe변환가이드.md     # EXE 변환 가이드
```

## 사용법

### 1. CLI 스크립트 사용 (settle_baemin.py)

```bash
cd adjustment
python settle_baemin.py <입력파일.xlsx> <출력파일.xlsx>
```

**예시:**
```bash
python settle_baemin.py driving_data.xlsx 정산_결과.xlsx
```

### 2. Streamlit 웹 앱 사용 (app.py)

```bash
cd adjustment
streamlit run app.py
```

브라우저에서 자동으로 열리며, 웹 인터페이스를 통해 파일을 업로드하고 처리할 수 있습니다.

### 3. 출력 파일 검증 (verify_output.py)

```bash
python verify_output.py <출력파일.xlsx>
```

### 4. EXE 파일로 변환

Python이 설치되지 않은 환경에서도 사용할 수 있도록 실행 파일(.exe)로 변환할 수 있습니다.

자세한 내용은 [`docs/exe변환가이드.md`](exe변환가이드.md)를 참조하세요.

**빠른 시작:**

```bash
# 1. PyInstaller 설치
pip install pyinstaller

# 2. 빌드 스크립트 실행
build_exe.bat

# 또는 직접 빌드
pyinstaller settle_baemin.py --name "배민정산계산기" --onefile
```

## 정산 기준

### 시간 기준
- **배민 정산 기준시간**: 06:00 ~ D+1 06:00
- **DB 정산 기준시간**: 00:00 ~ 24:00
- **보험사 기준영업일**: 시작시간의 YYYY-MM-DD

### 상태 정보
- **정산 대상**: 상태정보(M열) = '00'
- **정산 제외**: 상태정보(M열) ≠ '00' (전체 운행시간 삭제)

## 담보별 요율

| 담보 | 요율 |
|------|------|
| 대인1지원 | 3.28 |
| 대인2 | 4.34 |
| 대물 | 3.68 |

## 처리 순서

1. **운행시간 형식 변환** (G열, H열)
   - YYYY-MM-DD HH:MM:SS 형식으로 변환

2. **전체 운행시간 계산** (I열)
   - 종료시간(H열) - 시작시간(G열)

3. **정산 제외 처리**
   - 상태정보(M열)이 '00'이 아닌 경우 I열 값 삭제

4. **보험사 기준영업일 계산** (O열)
   - 시작시간(G열)의 YYYY-MM-DD

5. **일별 운행시간 합산**
   - 기사아이디(E열) + 기준영업일(O열)별 그룹화

6. **중복 시간 처리**
   - 이전 종료시간과 다음 시작시간 비교
   - 중복 구간 병합 및 중복 시간 계산
   - 정산운행시간 = 전체 시간 - 중복 시간

7. **보험료 계산**
   - 정산운행시간 × 담보별 요율
   - 원단위 절사
   - 담보별 합산

8. **일별 요약 생성**
   - 기사아이디 + 기준영업일별 보험료 집계

## 출력 시트

1. **01_상세_보험료**
   - 모든 운행 건별 상세 정보
   - 보험료 계산 결과 포함

2. **02_일자요약_보험료**
   - 기사아이디 + 기준영업일별 집계
   - 운행시간(분) 및 보험료

3. **03_병합구간(검증)**
   - 중복 구간 병합 결과
   - 검증용 데이터

## 의존성

필수 패키지:
- `pandas>=1.5.0,<2.0.0`
- `openpyxl>=3.1.0`
- `numpy>=1.21.0,<1.22.0`
- `streamlit>=1.28.0`

설치 방법:
```bash
pip install -r requirements.txt
```

## 주의사항

1. **입력 파일 형식**
   - Excel 파일(.xlsx) 형식이어야 합니다
   - 필수 컬럼: 기사이이디, 시작시간, 종료시간, 담보, 보험사 정산 상태 정보

2. **파일 다운로드**
   - Chrome에서 다운로드 중인 파일(.crdownload)은 사용할 수 없습니다
   - 다운로드가 완료된 후 .xlsx 확장자로 변경된 파일을 사용하세요

3. **보험료 계산**
   - 현재 구현은 중복 차감 전의 시간을 사용합니다
   - 요구사항에 따라 중복 차감 후 시간을 사용할 수도 있습니다

## 문제 해결

### 1. 패키지 의존성 충돌
- `numpy` 버전이 `scipy`, `numba`와 호환되지 않는 경우
- `requirements.txt`에 명시된 버전 범위를 확인하세요

### 2. 인코딩 오류 (Windows)
- Windows 콘솔에서 한글이 깨지는 경우
- `verify_output.py`는 자동으로 UTF-8 인코딩을 설정합니다

### 3. 파일 읽기 오류
- 파일이 손상되었거나 다운로드가 완료되지 않은 경우
- `.crdownload` 파일은 사용할 수 없습니다

## EXE 변환

Python이 설치되지 않은 Windows 환경에서도 사용할 수 있도록 실행 파일(.exe)로 변환할 수 있습니다.

**빌드 방법:**

```bash
# 자동 빌드 스크립트 사용
build_exe.bat

# 또는 수동 빌드
pyinstaller settle_baemin.py --name "배민정산계산기" --onefile
```

생성된 exe 파일은 `dist` 폴더에 저장됩니다.

자세한 내용은 [`docs/exe변환가이드.md`](exe변환가이드.md)를 참조하세요.

## 개발 이력

- **2025-12-26**: 초기 버전 작성
  - CLI 스크립트 (`settle_baemin.py`) 구현
  - Streamlit 웹 앱 (`app.py`) 구현
  - 출력 검증 스크립트 (`verify_output.py`) 구현
  - 요구사항 체크리스트 작성
  - EXE 변환 가이드 및 빌드 스크립트 추가

## 라이선스

내부 사용 목적으로 개발되었습니다.

