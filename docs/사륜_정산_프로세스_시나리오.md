# 사륜 정산(운행 원천 엑셀 → DB 결과 엑셀) 프로세스 시나리오 (완전판)

**작성일**: 2025-12-26 (KST)

---

## 0. 목적

플랫폼에서 내려받은 **운행 원천 데이터 엑셀**을 입력으로 받아,
1) **운행(건) 단위 결과 테이블**(보험사 운행 ID 기준)과  
2) **일자별 운행/중복운행 집계 테이블**(자차 포함/미포함 분리)  
을 생성하여 `DB 사륜_YYMMDD_YYMMDD.xlsx` 포맷으로 출력한다.

---

## 1. 입력/출력 정의

### 1.1 입력(대상 엑셀)

- **파일**: `driving_data_20251101_20251130 (1).xlsx`
- **헤더**(확인됨)
  - `No`
  - `보험사 운행 ID`
  - `플랫폼 운행 ID`
  - `기사이이디`
  - `이름`
  - `시작시간` (예: `2025-11-01T12:16:09+0900`)
  - `종료시간`
  - `전체 운행시간 (분단위)` *(원본 값이 0인 케이스 존재)*
  - `담보` (예: `nojacha` 등)
  - `전체 운행횟수`
  - `총 보험료`
  - `보험사 정산 상태 정보` (예: `정상`)
  - `배민기준영업일` (예: `20251101`)
  - `보험사기준영업일` (예: `20251101`)

### 1.2 출력(결과 엑셀)

- **파일**: `DB 사륜_251031_251130.xlsx`
- **실제 파일 구조**: **시트 내 2개의 테이블이 좌/우로 배치**
  - **A~N**: 운행(건) 단위 테이블
  - **P~U**: 일자별 집계 테이블(운행일/운행분/중복운행분)

#### (A~N) 운행(건) 단위 테이블 헤더(확인됨)

- `No`
- `보험사 운행 ID`
- `플랫폼 운행 ID`
- `기사ID`
- `이름`
- `시작시간`
- `종료시간`
- `운행시간` (엑셀 시간형: 예 `00:15:26`)
- `담보`
- `운행수`
- `보험료`
- `상태`
- `배민기준`
- `DB기준`

#### (P~U) 일자별 집계 테이블 헤더(확인됨)

- `운행일`
- `운행(분)_자차 포함`
- `운행(분)_자차 미포함`
- `중복운행(분)_자차포함`
- `중복운행(분)_자차미포함`

> **참고**: 결과 파일에서 동일 헤더가 뒤쪽에 한번 더 보이는 것은 엑셀 레이아웃/서식 영향으로 보이며,  
> 실질 집계 테이블은 위 5개 컬럼(P~U)을 사용하면 된다.

---

## 2. 처리 시나리오 (End-to-End)

### Step 1) 파일 로드 및 정규화

1. 입력 엑셀의 각 행을 읽는다(대용량 대비: `openpyxl read_only` 권장).
2. 컬럼 이름을 표준화한다.
   - `기사이이디` → `기사ID` (오타/표기 차이 통일)

### Step 2) 시간 파싱 및 운행분 계산

1. `시작시간`, `종료시간`을 KST 기준 datetime으로 파싱한다.
   - ISO8601 +0900 문자열이므로 파서 필요
2. 원본 `전체 운행시간 (분단위)`가 0 또는 공백인 케이스가 있으므로,
   - **기본값**: `운행분 = floor((종료-시작) / 60초)`
   - 원본 운행분이 정상적으로 들어오면 교차검증에 사용

### Step 3) 영업일(정산 기준일) 산정

입력에 `배민기준영업일`, `보험사기준영업일`이 이미 존재하므로 원칙은 아래처럼 사용:
- `배민기준` = 입력의 `배민기준영업일`
- `DB기준` = 입력의 `보험사기준영업일`

> **(필요 시 재계산 규칙)** 배민 기준은 "06:00~익일 06:00" 규칙을 사용.  
> 예: 2025-11-01 05:59는 전일 영업일, 06:00은 당일 영업일.

### Step 4) 운행(건) 단위 레코드 생성 (A~N)

입력 1행 → 출력 운행 테이블 1행으로 매핑하되 다음 규칙 적용:

- `운행시간`: 엑셀 time형(`HH:MM:SS`)으로 저장
  - `운행시간 = (종료-시작)`를 time delta로 변환
- `운행수`: 입력의 `전체 운행횟수`가 비어있으면 1로 보정
- `보험료`: 입력의 `총 보험료` 사용(이미 계산된 값이 존재)
- `상태`: 입력의 `보험사 정산 상태 정보`

### Step 5) 일자별 집계 테이블 생성 (P~U)

#### 5.1 집계 기준

- **집계 키**: `운행일`(날짜)
- **집계 대상**: 운행 구간(시작~종료)들의 "분 단위 길이"
- **자차 포함/미포함 분리**:
  - 담보가 자차 계열이면 "자차 포함"에만 반영
  - "자차 미포함"은 자차 담보를 제외하고 집계

> 실제 파일 샘플에서 `nojacha` 담보가 존재하므로,  
> 자차 관련 담보 코드는 운영 정의에 맞춰 `JACHA_CODES`로 분리한다(코드에서 설정).

#### 5.2 중복운행(분) 계산

같은 운행일 내에서 운행 구간들이 겹치는 시간을 **중복운행**으로 정의한다.

**중복운행(분) 계산 알고리즘(일자/조건별)**:

1. 해당 운행일의 모든 구간을 `(start, end)`로 모은다
2. `start` 기준 정렬 후, 스윕하며
   - 유니온 길이(`union_minutes`)
   - 단순합 길이(`sum_minutes`)
3. `중복운행분 = sum_minutes - union_minutes`

이 계산을 2번 수행:
- 자차 포함(전체 구간)
- 자차 미포함(자차 담보 제외 구간)

#### 5.3 최종 산출

- `운행(분)_자차 포함` = `sum_minutes`(전체)
- `운행(분)_자차 미포함` = `sum_minutes`(자차 제외)
- `중복운행(분)_자차포함` = `overlap_minutes`(전체)
- `중복운행(분)_자차미포함` = `overlap_minutes`(자차 제외)

---

## 3. 검증(체크리스트)

- [ ] **운행분**: `floor((종료-시작)/60)`와 입력 `전체 운행시간(분단위)`의 불일치율 확인
- [ ] **영업일**: 06:00 경계 전후 샘플 수동 검증
- [ ] **결과 운행 테이블 행수** == 입력 행수
- [ ] **일자별 집계**: 운행일별 합계가 기대 범위(예: 월 전체)와 일치
- [ ] **중복운행분**: 항상 0 이상이어야 하며, 운행분 합계보다 클 수 없음

---

## 4. 구현 참고

### Python

- `openpyxl(read_only=True)`로 스트리밍 처리 권장(엑셀 대용량 안정성)
- 시간 파싱: `pd.to_datetime()` 사용 시 ISO8601 +0900 형식 자동 처리
- 구간 병합 알고리즘: `merge_intervals()` 함수 구현 필요

### DB/SQL

(start, end) 구간의 유니온/오버랩 계산은 SQL만으로 난이도가 높아,

1. 원시 구간을 DB에 적재(staging)
2. 집계는 Python(또는 DB의 윈도우 함수 + 절차형)로 수행
3. 결과 테이블에 업서트

구조가 안전하다.

### 데이터 처리 주의사항

- **대용량 파일**: `read_only=True` 옵션으로 메모리 효율성 확보
- **시간 형식**: ISO8601 문자열을 datetime으로 변환 시 타임존 처리 주의
- **중복 계산**: 구간 병합 알고리즘의 정확성 검증 필수
- **자차 판별**: 담보 코드 매칭 로직의 정확성 확인

---

## 5. 예외 처리

### 5.1 데이터 품질 이슈

- **운행시간 0 또는 음수**: 기본값 계산(`floor((종료-시작)/60)`) 사용
- **영업일 누락**: 재계산 규칙 적용 또는 기본값 설정
- **담보 코드 불일치**: 자차 판별 로직에 따라 처리

### 5.2 오류 처리

- 파일 읽기 실패: 명확한 오류 메시지 제공
- 필수 컬럼 누락: 검증 단계에서 조기 발견 및 오류 보고
- 계산 오류: 로그 기록 및 부분 결과 저장 고려

---

## 6. 성능 고려사항

- **대용량 파일 처리**: 스트리밍 방식으로 메모리 사용량 최소화
- **중복 계산 최적화**: 일자별 그룹화 후 병렬 처리 가능
- **엑셀 출력**: 대용량 데이터의 경우 시트 분할 고려

---

## 7. 향후 개선 사항

- [ ] 자차 담보 코드 자동 감지 및 업데이트
- [ ] 영업일 재계산 옵션 추가
- [ ] 배치 처리 기능 (여러 파일 일괄 처리)
- [ ] 결과 검증 리포트 자동 생성
- [ ] 로그 및 오류 추적 시스템

---

## 8. 관련 문서

- [`사륜_정산_시나리오.md`](사륜_정산_시나리오.md) - 간략한 시나리오 문서
- [`README.md`](../README.md) - 프로젝트 개요 및 사용법

