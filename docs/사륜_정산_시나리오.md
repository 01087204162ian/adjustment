# 사륜 운행 데이터 → DB 정산 결과 변환 시나리오

## 전체 개요

**플랫폼 운행 원천 데이터(분 단위)**를 기준으로
담보별 운행시간을 집계 → 보험료 산출 → 중복·자차 여부를 분리 계산하여
DB 정산 기준 결과 엑셀을 생성하는 프로세스

---

## 입력 / 출력 파일 정의

### 입력 파일

**파일명**: `driving_data_20251101_20251130.xlsx`

**주요 컬럼**:
- 보험사 운행 ID
- 플랫폼 운행 ID
- 기사아이디 / 이름
- 시작시간 / 종료시간
- 전체 운행시간 (분단위)
- 담보
- 전체 운행횟수
- 총 보험료
- 배민기준영업일
- 보험사기준영업일
- 보험사 정산 상태 정보

**특징**:
- "운행 1건 단위"가 아니라 **시간 누적형 원천 데이터**
- 담보 단위가 이미 분리되어 있음

### 출력 파일

**파일명**: `DB_사륜_251031_251130.xlsx`

**주요 컬럼**:
- 보험사 운행 ID
- 플랫폼 운행 ID
- 시작시간 / 종료시간
- 운행시간
- 담보
- 운행수
- 보험료
- 상태
- 배민기준 / DB기준
- 운행일
- 운행(분)_자차 포함 / 미포함
- 중복운행(분)_자차 포함 / 미포함

**특징**:
- 정산·회계 기준 구조
- 중복 운행 / 자차 포함 여부를 명시적으로 분리

---

## 전체 처리 흐름 (Step by Step)

### Step 1. 원본 데이터 로드
- 대상 엑셀 전체 로드
- 날짜 범위: 2025-11-01 ~ 2025-11-30

### Step 2. 정산 기준 시간 필터링
- **배민 기준 영업일**: 06:00 ~ D+1 06:00
- 시작시간 / 종료시간을 기준으로 영업일 매핑 컬럼 생성

### Step 3. 운행 시간(분) 계산
- 기본 계산식: `운행시간(분) = 종료시간 - 시작시간`
- 초 단위 존재 시 → 분 단위 절사

### Step 4. 담보별 운행 시간 분리
- 담보 컬럼 기준 그룹핑
- 대인1, 대인2, 대물, 자차 등
- 담보별로 운행시간을 분리 집계

### Step 5. 자차 포함 / 미포함 분리
- 담보가 자차인 경우: `운행(분)_자차 포함`
- 자차 제외 대상: `운행(분)_자차 미포함`

### Step 6. 중복 운행 시간 계산
- 동일 기사 + 동일 시간대 + 복수 담보 발생 시
- 중복 구간 산출
- 중복 시간 분리:
  - `중복운행(분)_자차 포함`
  - `중복운행(분)_자차 미포함`

### Step 7. 보험료 산출
- 기본 공식: `보험료 = 운행시간(분) × 담보별 분당 보험료`
- **중요 규칙**: 분당 보험료 적용 후 → 원 단위 절사
- 담보별 절사 후 합산 (※ 매우 중요)

### Step 8. 운행수 계산
- 운행수 = 보험사 운행 ID 기준 count
- 동일 운행 ID 내 다중 담보는 1운행으로 처리

### Step 9. 상태값 부여
- 보험사 정산 상태 정보 기반
- 정상, 취소, 제외
- DB용 상태값으로 매핑

### Step 10. 결과 엑셀 생성
- 컬럼 구조를 DB 사륜 포맷에 맞게 재정렬
- 날짜 / 기준일 컬럼 생성
- 결과 엑셀 저장

---

## 컬럼 매핑 핵심 요약

| 원본 | 결과 |
|------|------|
| 전체 운행시간(분단위) | 운행시간 |
| 담보 | 담보 |
| 총 보험료 | 보험료 |
| 전체 운행횟수 | 운행수 |
| 배민기준영업일 | 배민기준 |
| 보험사기준영업일 | DB기준 |

---

## 담보별 분당 보험료

| 담보 | 요율 (원/분) |
|------|-------------|
| 대인1 / 대인1지원 | 3.28 |
| 대인2 | 4.34 |
| 대물 | 3.68 |
| 자차 | 0.0 (보험료 없음) |

---

## 사용법

### CLI 스크립트

```bash
python settle_saryun.py driving_data_20251101_20251130.xlsx --out DB_사륜_251031_251130.xlsx
```

### Python 코드 예시

```python
import pandas as pd
from settle_saryun import process

# 처리 실행
process(
    input_xlsx="driving_data_20251101_20251130.xlsx",
    output_xlsx="DB_사륜_251031_251130.xlsx"
)
```

---

## 주요 알고리즘

### 배민 기준 영업일 계산

```python
def calc_baemin_business_day(start_time):
    """
    06:00 이전 → 전날
    06:00 이후 → 당일
    """
    if start_time.hour < 6:
        return (start_time - timedelta(days=1)).date()
    else:
        return start_time.date()
```

### 중복 운행 시간 계산

1. 동일 기사 + 동일 영업일 그룹화
2. 시간 구간 병합 (merge_intervals)
3. 총 시간 - 병합 시간 = 중복 시간

### 보험료 계산

```python
# 각 담보별로 원단위 절사 후 합산
for 담보 in 담보목록:
    보험료 += floor(운행시간(분) × 분당요율)
```

---

## 주의사항

1. **보험료 계산 순서**: 담보별로 원단위 절사 후 합산 (중요!)
2. **자차 처리**: 자차는 보험료가 0원이지만 운행시간은 포함
3. **중복 시간**: 자차 포함/미포함을 별도로 계산
4. **영업일 기준**: 배민 기준(06:00~D+1 06:00)과 DB 기준(00:00~24:00) 구분

---

## 문제 해결

### Q: 보험료가 0으로 나오는 경우
A: 담보명이 정확히 매칭되는지 확인하세요. 대소문자 구분 없이 검색합니다.

### Q: 중복 시간이 계산되지 않는 경우
A: 기사아이디와 영업일이 정확히 일치하는지 확인하세요.

### Q: 자차가 포함되지 않는 경우
A: 담보명에 "자차", "자기부담금", "자기부담" 키워드가 포함되어 있는지 확인하세요.

