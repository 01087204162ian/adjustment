# 시간제보험(사륜차) 운행 데이터 정산 작업 정리

## 1. 목표 정의

### 1.1 중간 목표
- 현재 직원이 산출한 결과 파일과 **동일한 형태의 일자별 운행시간 요약표**를
  재현 가능하게 생성한다.

즉,
- 보험사 기준영업일(일자)별
- 자차 포함 / 자차 미포함
- 운행시간(분)
- 중복 운행시간 반영

까지를 **중간 목표**로 한다.

### 1.2 최종 목표
- 중간 목표 결과를 기반으로
- 자차 포함 / 미포함 분당 단가를 적용하여
- **일자별 보험료 산출 표**까지 완성한다.

---

## 2. 데이터 전제 및 컬럼 정의

### 2.1 주요 컬럼

| 구분 | 컬럼 |
|---|---|
| 보험사 기사아이디 | D |
| 운행 시작시간 | F |
| 운행 종료시간 | G |
| 전체 운행시간(분) | H |
| 보험사 정산 상태 | L |
| 보험사 기준영업일 | N |

### 2.2 시간 포맷
- 운행 시작시간(F), 종료시간(G)은  
  `YYYY-MM-DD HH:MM:SS` 형식으로 통일한다.

---

## 3. 정산 기준 정의

### 3.1 하루(기준영업일) 기준
- 보험사 기준영업일 = **운행 시작시간(F열)의 날짜**
- 배달의민족의 06:00 기준은 플랫폼 내부에서 이미 반영된 데이터로 간주한다.

---

## 4. 운행 및 시간 산출 로직

### 4.1 운행 정의
- 배차 수락 시점부터
- 해당 시점에 보유한 모든 배달을 완료할 때까지를 **1회 운행**으로 정의한다.
- 다건배송은 하나의 운행 ID로 묶어 **1회의 유상운송행위**로 본다.

### 4.2 운행시간 계산
- 운행시간(초) = 종료시간(G) − 시작시간(F)
- 기사별 모든 운행시간을 초 단위로 합산
- 분 단위 환산 시 **올림 처리**
  - 예: 121분 40초 → 122분

---

## 5. 정산 제외 조건

### 5.1 보험사 정산 상태(L열)
- 값이 `00`이 아닌 경우
  - 해당 행의 운행시간(H열)은 정산에서 제외
- 단, 시간제보험에는 "정산 예외 운행" 개념은 없음
  - 0분 1초라도 운행이 존재하면 1분으로 인정
  - 배차 취소도 운행으로 인정

---

## 6. 기사·일자별 운행시간 집계

- 집계 기준 키
  - 보험사 기사아이디(D)
  - 보험사 기준영업일(N)
- 위 기준으로 전체 운행시간(분)을 합산

---

## 7. 중복 운행 처리

### 7.1 중복 검증 기준
- 동일 기사 + 동일 기준영업일 내에서
- 정렬 기준
  - 기사아이디(D) 오름차순
  - 운행 시작시간(F) 기준

### 7.2 중복 판단 조건
- 이전 종료시간(G) > 다음 시작시간(F) 인 경우 중복으로 판단

### 7.3 중복 운행시간 계산
- 중복시간 = 이전 종료시간 − 다음 시작시간
- 분 단위로 환산

### 7.4 중복 차감
- 기사·일자별 전체 운행시간(분)에서
- 산출된 중복 운행시간을 차감
- 결과값을 **정산 인정 운행시간(분)**으로 확정

---

## 8. 중간 목표 산출물 (현재 파일 수준)

### 8.1 일자별 운행시간 요약 표

| 운행일 | 운행(분)_자차포함 | 운행(분)_자차미포함 | 중복운행(분)_자차포함 | 중복운행(분)_자차미포함 | 정산 운행(분)_자차포함 | 정산 운행(분)_자차미포함 |
|---|---:|---:|---:|---:|---:|---:|

- 현재 직원 산출 파일은 이 구조에 해당
- 본 프로젝트의 **중간 목표 결과물**

---

## 9. 보험료 산출 기준 (최종 목표)

### 9.1 분당 단가
- 자차 포함: **11.6원 / 분**
- 자차 미포함: **9.02원 / 분**

### 9.2 보험료 계산
- 보험료 = 정산 인정 운행시간(분) × 분당 단가
- 보험사별 예외
  - 현대: 일 5시간 초과 시 고정요율 존재
  - DB: 고정요율 없음
- 원단위 절사/반올림 여부는 보험사 기준에 따라 적용

---

## 10. 최종 목표 산출물

### 10.1 일자별 보험료 결과 표

| 기준영업일 | 자차구분 | 정산 운행시간(분) | 분당 단가 | 산출 보험료 |
|---|---|---:|---:|---:|

### 10.2 월 합계 요약
- 기간 내 총 운행시간
- 총 보험료
- 보험사 제출용 최종 수치

---

## 11. 정리

- 현재 파일: **중간 목표 달성 상태**
- 추가 작업 목표:
  1. 재현 가능한 로직 정립
  2. 기사 단위 → 일자 요약 → 보험료 산출 흐름 완성
- 본 문서는
  - 개발 기준
  - 내부 검증 기준
  - 보험사 설명 기준
  으로 공동 사용한다.
