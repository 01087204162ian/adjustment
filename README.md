# 시간제보험(사륜차) 운행 데이터 정산 파이프라인

## 개요

시간제보험(사륜차) 운행 데이터를 처리하여 일자별 운행시간 요약표와 보험료를 산출하는 파이프라인입니다.

- **중간 목표**: 직원 산출 파일과 동일한 형태의 "일자별 운행시간 요약표" 재현
- **최종 목표**: 요약표에 보험료(자차 포함/미포함 단가 적용)까지 산출

## 설치

```bash
pip install -r requirements.txt
```

필수 패키지:
- pandas>=1.5.0,<2.0.0
- openpyxl>=3.1.0
- numpy>=1.21.0

## 사용법

### CLI 실행

```bash
python settle_saryun.py <입력파일.xlsx> --out <출력파일.xlsx>
```

예시:
```bash
python settle_saryun.py driving_data_20251101_20251130.xlsx --out 정산_결과.xlsx
```

## 입력 파일 형식

Excel(xlsx) 파일이며, 다음 열 기준으로 데이터를 읽습니다:

| 열 | 컬럼 | 설명 |
|---|---|---|
| D | 보험사 기사아이디 | - |
| F | 운행 시작시간 | `YYYY-MM-DD HH:MM:SS` 형식 |
| G | 운행 종료시간 | `YYYY-MM-DD HH:MM:SS` 형식 |
| H | 전체 운행시간(분) | 계산 후 덮어씀 |
| I | 담보(자차 구분) | `jacha` 또는 `nojacha` |
| L | 보험사 정산 상태 | `00`이면 정상, 아니면 제외 |
| N | 보험사 기준영업일 | 계산 후 덮어씀 |

## 핵심 전제

### 시간 및 날짜 처리

- **보험사 기준영업일 = 운행 시작시간(F)의 날짜**
- 시간 포맷: F, G는 `YYYY-MM-DD HH:MM:SS`로 파싱/표준화
- 운행시간 계산: `H = ceil((G - F).seconds / 60)`
  - 예: 121분 40초 → 122분 (올림 처리)

### 정산 제외

- `L != '00'` 인 행은 정산에서 제외 → `H = NaN`

### 자차 구분

- 컬럼: **I열(담보)**
- 값 매핑:
  - `jacha` → 자차 포함
  - `nojacha` → 자차 미포함
- 대소문자/공백 안전 처리 (자동 정규화)

## 처리 단계

### Step 1. 시간 파싱/표준화
- F, G 파싱 실패 → 오류 리포트
- 종료 < 시작 → 오류 리포트

### Step 2. 운행시간(분) 재계산
- `H = ceil((G-F)/60초)`

### Step 3. 정산 제외 반영
- L 정규화 후 '00' 비교
- `L != '00'` → `H = NaN`

### Step 4. 기준영업일 생성
- `N = date(F)` (YYYY-MM-DD)

### Step 5. 중복 운행 처리

#### Step 5-1. 정렬
- D asc, N asc, F asc

#### Step 5-2. 중복 판단
- 동일 (D, N) 내에서
  - `prev_G > next_F` 이면 중복
- 중복시간(초) = `prev_G - next_F`
- 중복시간(분) = `ceil(중복시간(초)/60)`

#### Step 5-3. 중복시간의 자차 귀속 규칙 (중요!)
- **중복시간은 '다음 운행(next row)'의 담보(I열) 구분을 따른다**
  - next row의 I == 'jacha' → 중복운행(분)_자차포함에 누적
  - next row의 I == 'nojacha' → 중복운행(분)_자차미포함에 누적

### Step 6. 일자별 요약표 생성

운행일(=N) 단위로 집계:

- 운행일
- 운행(분)_자차포함 = sum(H where I=='jacha')
- 운행(분)_자차미포함 = sum(H where I=='nojacha')
- 중복운행(분)_자차포함 = Step 5에서 누적된 중복시간(분) 합
- 중복운행(분)_자차미포함 = Step 5에서 누적된 중복시간(분) 합
- 정산_운행(분)_자차포함 = 운행(분)_자차포함 - 중복운행(분)_자차포함
- 정산_운행(분)_자차미포함 = 운행(분)_자차미포함 - 중복운행(분)_자차미포함

### Step 7. 보험료 산출

#### 단가 (확정)
- 자차 포함: **11.6 원/분**
- 자차 미포함: **9.02 원/분**

#### 계산
- 보험료_자차포함 = 정산_운행(분)_자차포함 × 11.6
- 보험료_자차미포함 = 정산_운행(분)_자차미포함 × 9.02
- 일자_총보험료 = 보험료_자차포함 + 보험료_자차미포함
- 원 단위 처리: 반올림 (round)

## 출력 파일 구조

Excel 파일로 3개 시트가 생성됩니다:

### Sheet1: `정산_요약(일자)`
일자별 요약표 (중간 목표 + 보험료 포함 최종 결과)

컬럼:
- 운행일
- 운행(분)_자차포함
- 운행(분)_자차미포함
- 중복운행(분)_자차포함
- 중복운행(분)_자차미포함
- 정산_운행(분)_자차포함
- 정산_운행(분)_자차미포함
- 보험료_자차포함
- 보험료_자차미포함
- 일자_총보험료

### Sheet2: `중복_상세(기사)`
검증용 중복 운행 상세 데이터

컬럼:
- D: 기사아이디
- N: 기준영업일
- prev_F: 이전 운행 시작시간
- prev_G: 이전 운행 종료시간
- next_F: 다음 운행 시작시간
- next_G: 다음 운행 종료시간
- overlap_min: 중복시간(분)
- next_I: 다음 행의 담보

### Sheet3: `오류_리포트`
처리 중 발생한 오류 내역

컬럼:
- 행_번호: Excel 행 번호
- 유형: 오류 유형
- 설명: 오류 설명
- 값: 오류 발생 값

오류 유형:
- 시간 파싱 실패: F 또는 G 파싱 불가
- 시간 논리 오류: 종료시간 < 시작시간
- 담보 구분 불가: I열이 'jacha' 또는 'nojacha'가 아님

## 테스트

단위 테스트 실행:

```bash
python test_settle_saryun.py
```

테스트 케이스:
1. 하루 경계 케이스
2. 중복 운행 케이스

## 구현 요구사항

- Python + pandas
- 대용량 처리 고려: dtype 최적화, vectorized 연산
- CLI 인터페이스
- 단위 테스트 포함

## 주의사항

1. **중복시간 귀속 규칙**: 중복시간은 다음 행의 담보 구분을 따르므로, 정렬 순서가 중요합니다.
2. **정산 제외**: 정산 상태가 '00'이 아닌 행은 정산에서 제외되지만, 오류 리포트에는 기록되지 않습니다.
3. **올림 처리**: 운행시간은 분 단위로 올림 처리되므로, 1초라도 있으면 1분으로 계산됩니다.

